var c3d=c3d||{};c3d.Scene=function(b){this.animationSpeeds={camera:1};this.cameraOrbit={x:0,y:0,z:1500};this.shading={flat:false};this.namespace="c3d_";this.modelDir="models/";this.perspective=1000;for(var a in b){this[a]=b[a]}this.cssStyles={scene:[[c3d.cssVendorPrefix,"perspective: ",this.perspective,";"].join(""),[c3d.cssVendorPrefix,"transform-style: preserve-3d;"].join(""),"position: absolute;","background-color: transparent;"].join(""),camera:[[c3d.cssVendorPrefix,"transform-style: preserve-3d;"].join(""),[c3d.cssVendorPrefix,"perspective-origin: 50% 50%;"].join(""),[c3d.cssVendorPrefix,"transition: all ",this.animationSpeeds.camera,"s ease-in-out;"].join(""),"position: absolute;","width: 100%;","height: 100%;"].join(""),face:["position: absolute;","top: 50%;","left: 50%;"].join("")};this.modelName="";this.displayWidth=0;this.displayHeight=0;this.camera=null;this.setupCamera();this.geometry=new THREE.Geometry();this.sceneEl=document.createElement("div");this.sceneEl.setAttribute("class",this.namespace+"scene");this.camera.htmlEl.setAttribute("class",this.namespace+"camera");this.sceneEl.appendChild(this.camera.htmlEl);this.htmlEl=this.sceneEl;this.htmlEl.style.cssText+=this.cssStyles.scene;return this};c3d.Scene.prototype={getGeometryDimensions:function(){var a=this.geometry.boundingBox;return{width:a.max.x-a.min.x,height:a.max.y-a.min.y,depth:a.max.z-a.max.z}},setFaceContent:function(b,c){var a=this.geometry.faces[b];a.contentEl.innerHTML=c;return this},setCameraOrbit:function(a,c,b){this.cameraOrbit={x:a,y:c,z:b}},setDisplaySize:function(b,a){this.displayWidth=b;this.displayHeight=a},setupCamera:function(){var a=[];a=new THREE.Camera(35,1,1,10000);a.position=new THREE.Vector3(this.cameraOrbit.x,this.cameraOrbit.y,this.cameraOrbit.z);a.htmlEl=document.createElement("div");this.camera=a;this.camera.htmlEl.style.cssText+=this.cssStyles.camera;return this},loadModel:function(b,d){this.modelName=b;var e=this.modelDir+this.modelName+".json";var a=new THREE.JSONLoader();var c=this;a.load(e,function(f){c.setGeometry(f);d(c);c.render()},"");return this},setGeometry:function(k){this.geometry=k;this.geometry.computeBoundingBox();var e=k.faces;var h=k.vertices;for(var l=0;l<e.length;l++){var i=e[l];var j={a:h[i.a],b:h[i.b],c:h[i.c],d:h[i.d]};var d=i.centroid;var a=new THREE.Vector3().sub(j.d,j.c);var c=new THREE.Vector3().sub(j.b,j.c);var b=c.length(),m=a.length();a.normalize();c.normalize();var g=[c.x,c.y,c.z,0,a.x,a.y,a.z,0,0,0,1,0,d.x,d.y,d.z,1];i.width=b;i.height=m;i.index=l;i.htmlEl=f(b,m,this.cssStyles.face,this.namespace);i.htmlEl.style[c3d.jsVendorPrefix+"Transform"]=this.getMatrixCss(g);i.contentEl=null;i.timeouts=[];this.camera.htmlEl.appendChild(i.htmlEl)}function f(q,n,r,p){var o=document.createElement("div");o.style.width=q+"px";o.style.height=n+"px";o.style.marginLeft=(-q/2)+"px";o.style.marginTop=(-n/2)+"px";o.setAttribute("class",p+"face");o.style.cssText+=r;return o}return this},getMatrixCss:function(g){var b="";if(c3d.jsVendorPrefix=="Moz"){var c=g;var h=new THREE.Matrix4(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],c[12],c[13],c[14],c[15]);var j=new THREE.Vector3().getPositionFromMatrix(h);var d=new THREE.Vector3().getScaleFromMatrix(h);var a=new THREE.Vector3().getRotationFromMatrix(h);console.log(d);b=["rotate(",a.x,"deg ",a.y,"deg ",a.z,"deg",")","scale(",d.x,d.y,d.z,")","translate(",j.x,j.y,j.z,")"].join(" ")}else{var f=new Array(g.length);for(var e=0;e<g.length;e++){f[e]=c3d.toFixed(g[e])}b=["matrix3d(",f.join(","),")"].join("")}return b},render:function(){this.camera.updateMatrixWorld(true);this.camera.updateMatrix();var a=new THREE.Matrix4().getInverse(this.camera.matrixWorld.clone()).elements;var d=new Array(a.length);var b=[a[0],-a[1],a[2],a[3],a[4],-a[5],a[6],a[7],a[8],-a[9],a[10],a[11],a[12],-a[13],a[14],a[15]];for(var c=0;c<b.length;c++){d[c]=c3d.toFixed(b[c])}this.camera.htmlEl.style[c3d.jsVendorPrefix+"Transform"]="matrix3d("+d.join(",")+")";if(this.shading.flat===true){this.flatShading()}return this},moveCameraToOrbit:function(){var b=this.camera;var d=0;var c=this;var a=new THREE.Vector3(this.cameraOrbit.x,this.cameraOrbit.y,this.cameraOrbit.z);if(!b.position.equals(a)){b.position=a;b.rotation=new THREE.Vector3();b.lookAt(new THREE.Vector3(0,0,0));this.render();d=this.animationSpeeds.camera}this.lastAnimationTimeout=d;return this},flatShading:function(){var b=this.geometry.faces;var j=this.camera;var f=this.camera.position;var m=0.1;var c=10000;for(var h=0;h<b.length;h++){var k=b[h];var a=k.centroid;var p=new THREE.Vector3().sub(a,f);var l=k.normal.clone();var e=Math.acos(p.dot(l)/(p.length()*l.length()));var d=1-Math.cos(e+Math.PI/2)*-1;var g=1-(p.length()/c);if(g<0){g=0}var n=(d*g)+m;var o=parseInt(n*255,10);k.htmlEl.style["background-color"]="rgba("+[o,o,o].join(",")+", 1)";k.lightIntensity=o}return this}};var c3d=c3d||{};c3d.cssVendorPrefix=(function(d){var b=["Moz","ms","O","Webkit"];var c=document.createElement("div");for(var a=b.length-1;c.style[b[a]+"Transform"]===d&&a>-1;a--){continue}return(a<0)?"":["-",b[a].toLowerCase(),"-"].join("")})();c3d.jsVendorPrefix=(function(d){var b=["Moz","ms","O","Webkit"];var c=document.createElement("div");for(var a=b.length-1;c.style[b[a]+"Transform"]===d&&a>-1;a--){continue}return(a<0)?"":b[a]})();c3d.toFixed=function(a){var c=false,b;if(a<0){a*=-1;c=true}if(Math.abs(a)<1){b=parseInt(a.toString().split("e-")[1],10);if(b){a*=Math.pow(10,b-1);a="0."+(new Array(b)).join("0")+a.toString().substring(2)}}else{b=parseInt(a.toString().split("+")[1],10);if(b>20){b-=20;a/=Math.pow(10,b);a+=(new Array(b+1)).join("0")}}if(c){a="-"+a}return a};